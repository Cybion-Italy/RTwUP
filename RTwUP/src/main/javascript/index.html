<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<meta name="author"
	content="Gabriele de Capoa, Gabriele Proni, Daniele Morgantini">
<title>RTwUP - Realtime Twitter URL Popularity</title>
<script type="text/javascript" src="http://localhost:8000/socket.io/socket.io.js"></script>
<script type="text/javascript">

	var socket = io.connect('http://localhost:8000/');

	socket.on('connect', function(data) {
		setStatus('connected');
		socket.emit('subscribe', {channel : 'RTwUP'});
	});

	socket.on('reconnecting', function(data) {
		setStatus('reconnecting');
	});

	socket.on('message', function(data) {
		console.log('received a message: ', data);
		addMessage(data);
	});

	function addMessage(data) {
		document.getElementById("ranking").innerHTML = getHTMLcode(data);
	}

	function setStatus(msg) {
		console.log('Connection Status : ' + msg);
	}
	
	function getHTMLcode(data) {
		var result = "";
		
		/* Some cleaning before JSON.parse can process the stringified object*/
		var stringa = data.replace(/\\/g,"");
		stringa = stringa.replace(/"\["/g,"[");
		stringa = stringa.replace(/"\]"/g,"]");
		stringa = stringa.replace(/"{/g,"{");
		stringa = stringa.replace(/}"/g,"}");
		
		var json = JSON.parse(stringa);
		
		json.dp.forEach(function(dElem) {
			result += "<h3>" + dElem.domain +"</h3>";
			dElem.pages.forEach(function(pElem) {
				result += "<p> <a href=\"" + pElem.page + "\">"+ pElem.page + "</a> &nbsp &nbsp &nbsp " + pElem.count + "</p>";
			})
		});
		return result;
	}
 </script>
</head>

<body>
	<header>
		<h1>RTwUP</h1>
		<p>Realtime Twitter URL Popularity</p>
	</header>

	<h2>Ranking of most twitted URLs</h2>
	<div id="ranking">
	</div>
	
	<footer id="footer">Copyright &copy; 2013 Gabriele de Capoa, Gabriele Proni &amp; Daniele Morgantini, for "Gestione delle Informazioni su Web" course </footer>
	
</body>

</html>
